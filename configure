#!/usr/bin/ruby

require 'rbconfig'

PLATFORM = lambda {
  if RbConfig::CONFIG['target_os'] =~ /windows/i
    'windows'
  elsif RbConfig::CONFIG['target_os'] =~ /mingw32/i
    'windows'
  elsif RbConfig::CONFIG['target_os'] =~ /cygwin/i
    'cygwin'
  elsif RbConfig::CONFIG['target_os'] =~ /darwin/i
    'macosx'
  elsif RbConfig::CONFIG['target_os'] =~ /linux/i
    'linux'
  elsif RbConfig::CONFIG['target_os'] =~ /bsd/i
    'bsd'
  else
    raise "#{RbConfig::CONFIG['target_os']} is an unknown platform!"
  end
}.call

case ARGV[0]
  when 'debug'
  when 'development'
  when 'release'
  else
    raise "`#{ARGV[0]}` is an invalid configuration!\n"
end

BUILD = ARGV[0]
FOUNDATION_BUILD = lambda {
  case ARGV[0]
    when 'debug'
      'debug'
    when 'development'
      'release'
    when 'release'
      'release'
  end
}.call

File.open('tup.config', 'w') do |cfg|
  cfg.write "# This file was generated by ./configure #{ARGV.join(' ')}\n\n"
  cfg.write "CONFIG_BUILD=#{BUILD}\n"
  cfg.write "CONFIG_FOUNDATION_BUILD=#{FOUNDATION_BUILD}\n"

  if PLATFORM == 'windows'
    WINDOWS_SDK_DIR = `"%VCINSTALLDIR%\\vcvarsall.bat" & set WindowsSdkDir`.split('WindowsSdkDir=')[1].strip
    cfg.write "CONFIG_WINDOWS_SDK_DIR=#{WINDOWS_SDK_DIR}\n"
  end
end